<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anonymous Chat (Human or AI)</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 720px; margin: 24px auto; }
      #messages { border: 1px solid #ddd; height: 360px; padding: 12px; overflow-y: auto; background: #fafafa; }
      .msg { margin: 6px 0; }
      .me { color: #0b5394; }
      .partner { color: #0b7a3f; }
      #controls { margin-top: 12px; display:flex; gap:8px; }
      #promptArea { margin-top: 12px; }
      button { padding: 8px 12px; }
    </style>
  </head>
  <body>
    <h2>Anonymous Chat — Human or AI?</h2>

    <div id="landing">
      <p>Welcome to ChatMirage! Click below to start chatting anonymously with a human or AI.</p>
      <button id="startBtn">Start Chat</button>
    </div>

    <div id="chatUI" style="display:none">
      <div id="status">Not connected</div>
      <div id="typingIndicator" style="color:#888;margin-top:6px;height:18px"></div>
      <div id="messages"></div>
      <div id="controls">
        <input id="messageInput" placeholder="Type a message" style="flex:1" />
        <button id="sendBtn">Send</button>
        <button id="skipBtn">Skip</button>
      </div>
      <div id="promptArea"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const landing = document.getElementById('landing');
      const chatUI = document.getElementById('chatUI');
      const startBtn = document.getElementById('startBtn');

      let socket = null;
      let sessionId = null;
      let partnerType = null;
      const statusEl = document.getElementById('status');
      const messagesEl = document.getElementById('messages');
      const typingIndicator = document.getElementById('typingIndicator');
      const inputEl = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const promptArea = document.getElementById('promptArea');

      function addMessage(from, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (from === 'me' ? 'me' : 'partner');
        div.textContent = (from === 'me' ? 'Me: ' : 'Partner: ') + text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }


      function showChatUI() {
        landing.style.display = 'none';
        chatUI.style.display = '';
      }

      function showLanding() {
        landing.style.display = '';
        chatUI.style.display = 'none';
      }

      const STARTED_KEY = 'chatmirage_started';
      const STARTED_EXPIRY_MS = 15 * 60 * 1000;

      function setStarted() {
        try {
          const payload = { startedAt: Date.now() };
          localStorage.setItem(STARTED_KEY, JSON.stringify(payload));
        } catch (e) {}
      }

      function clearStarted() {
        try { localStorage.removeItem(STARTED_KEY); } catch (e) {}
      }

      function isStartedValid() {
        try {
          const raw = localStorage.getItem(STARTED_KEY);
          if (!raw) return false;
          const o = JSON.parse(raw);
          if (!o || !o.startedAt) return false;
          return (Date.now() - o.startedAt) <= STARTED_EXPIRY_MS;
        } catch (e) { return false; }
      }


      function getUserId() {
        let userId = localStorage.getItem('chatmirage_userid');
        if (!userId) {
          userId = 'u_' + Math.random().toString(36).substr(2, 12);
          localStorage.setItem('chatmirage_userid', userId);
        }
        return userId;
      }

      function connectSocket() {
        const urlParams = new URLSearchParams(location.search);
        const forced = urlParams.get('force');
        const userId = getUserId();
        socket = forced ? io({ auth: { forcePartner: forced, userId } }) : io({ auth: { userId } });

        socket.on('connect', () => {
          if (!sessionId) {
            statusEl.textContent = 'Connected. Searching for partner...';
          } else {
            statusEl.textContent = `Reconnected to session ${sessionId}`;
          }
        });

        let myRole = null;
        socket.on('paired', (data) => {
          sessionId = data.sessionId;
          partnerType = data.partnerType;
          statusEl.textContent = `Paired — Partner: ${data.partnerType} (${data.partnerId}) — Session ${sessionId}`;
          appendPromptArea('Paired! Say hi.');
          
          myRole = partnerType === 'ai' ? 'human' : 'human';
          socket.emit('request_history', { sessionId });
        });

        socket.on('chat_message', (data) => {
          addMessage(data.from, data.text);
        });

        socket.on('chat_history', (data) => {
          messagesEl.innerHTML = '';
          const userId = getUserId();
          if (data && Array.isArray(data.chatHistory)) {
            data.chatHistory.forEach(msg => {
              
              if (msg.userId && msg.userId === userId) {
                addMessage('me', msg.text);
              } else if (msg.from === 'ai') {
                addMessage('partner', msg.text);
              } else if (msg.from === 'human' && myRole === 'human') {
                addMessage('me', msg.text);
              } else {
                addMessage('partner', msg.text);
              }
            });
          }
        });

        socket.on('partner_typing', (data) => {
          showTyping(true);
        });

        socket.on('partner_stop_typing', (data) => {
          showTyping(false);
        });

        socket.on('turing_prompt', (data) => {
          promptArea.innerHTML = '';
          const p = document.createElement('div');
          p.textContent = data.prompt;
          promptArea.appendChild(p);
          const humanBtn = document.createElement('button');
          humanBtn.textContent = 'Human';
          humanBtn.onclick = () => submitGuess('Human');
          promptArea.appendChild(humanBtn);
          const aiBtn = document.createElement('button');
          aiBtn.textContent = 'AI';
          aiBtn.onclick = () => submitGuess('AI');
          promptArea.appendChild(aiBtn);
        });

        socket.on('guess_result', (data) => {
          if (data.correct) {
            appendPromptArea('Your guess was correct. Waiting for continue/end options...');
          } else {
            appendPromptArea('Incorrect guess.');
          }
        });

        socket.on('post_guess_options', (data) => {
          promptArea.innerHTML = '';
          const p = document.createElement('div');
          p.textContent = data.message;
          promptArea.appendChild(p);
          const cont = document.createElement('button');
          cont.textContent = 'Continue';
          cont.onclick = () => submitContinueChoice('continue');
          promptArea.appendChild(cont);
          const end = document.createElement('button');
          end.textContent = 'End Chat';
          end.onclick = () => submitContinueChoice('end');
          promptArea.appendChild(end);
        });

        socket.on('resume_chat', (data) => {
          appendPromptArea(data.message);
          setTimeout(() => (promptArea.innerHTML = ''), 1500);
        });

        socket.on('chat_ended', (data) => {
          appendPromptArea('Chat ended: ' + (data.reason || 'unknown'));
          statusEl.textContent = 'Chat ended. Reload page to try again.';
          inputEl.disabled = true;
          sendBtn.disabled = true;
          clearStarted();
          showLanding();
        });

        socket.on('partner_disconnected', (data) => {
          appendPromptArea(data.message || 'Partner disconnected');
          statusEl.textContent = 'Partner disconnected. Chat ended.';
          inputEl.disabled = true;
          sendBtn.disabled = true;
          clearStarted();
          showLanding();
        });

        function submitGuess(guess) {
          if (!sessionId) return;
          socket.emit('submit_guess', { sessionId, guess });
          appendPromptArea('You guessed: ' + guess);
        }

        function submitContinueChoice(choice) {
          if (!sessionId) return;
          socket.emit('submit_continue_choice', { sessionId, choice });
          appendPromptArea('You chose: ' + choice);
        }

        function appendPromptArea(text) {
          const d = document.createElement('div');
          d.textContent = text;
          promptArea.appendChild(d);
        }

        let typing = false;
        let typingTimeout = null;
        const TYPING_DELAY = 1400;

        function showTyping(flag) {
          if (!typingIndicator) return;
          typingIndicator.textContent = flag ? 'Partner is typing...' : '';
        }

        inputEl.addEventListener('input', () => {
          if (!socket || !sessionId) return;
          if (!typing) {
            typing = true;
            socket.emit('typing', { sessionId });
          }
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            typing = false;
            if (socket && sessionId) socket.emit('stop_typing', { sessionId });
          }, TYPING_DELAY);
        });


        sendBtn.onclick = () => {
          const text = inputEl.value.trim();
          if (!text || !sessionId) return;
          socket.emit('send_message', { sessionId, text });
          
          if (socket && sessionId) socket.emit('stop_typing', { sessionId });
          typing = false;
          clearTimeout(typingTimeout);
          inputEl.value = '';
        };

        const skipBtn = document.getElementById('skipBtn');
        skipBtn.onclick = () => {
          if (socket && sessionId) socket.emit('stop_typing', { sessionId });
          socket.emit('skip_partner');
          statusEl.textContent = 'Searching for new partner...';
          messagesEl.innerHTML = '';
          promptArea.innerHTML = '';
          inputEl.disabled = false;
          sendBtn.disabled = false;
        };

        inputEl.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            sendBtn.click();
          }
        });
      }

 
      if (isStartedValid()) {
        showChatUI();
        connectSocket();
      } else {
        startBtn.onclick = () => {
          setStarted();
          showChatUI();
          connectSocket();
        };
      }
    </script>
  </body>
</html>
