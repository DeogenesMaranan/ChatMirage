<!-- public/index.html -->
<!--
  Single-page frontend for anonymous 1-to-1 chat.
  - Connects to Socket.io backend
  - Displays messages
  - Sends messages
  - Shows Turing prompt every 10 messages with guess buttons
  - If guess correct, shows continue/end buttons
-->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anonymous Chat (Human or AI)</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 720px; margin: 24px auto; }
      #messages { border: 1px solid #ddd; height: 360px; padding: 12px; overflow-y: auto; background: #fafafa; }
      .msg { margin: 6px 0; }
      .me { color: #0b5394; }
      .partner { color: #0b7a3f; }
      #controls { margin-top: 12px; display:flex; gap:8px; }
      #promptArea { margin-top: 12px; }
      button { padding: 8px 12px; }
    </style>
  </head>
  <body>
    <h2>Anonymous Chat — Human or AI?</h2>

    <div id="landing">
      <p>Welcome to ChatMirage! Click below to start chatting anonymously with a human or AI.</p>
      <button id="startBtn">Start Chat</button>
    </div>

    <div id="chatUI" style="display:none">
      <div id="status">Not connected</div>
      <div id="messages"></div>
      <div id="controls">
        <input id="messageInput" placeholder="Type a message" style="flex:1" />
        <button id="sendBtn">Send</button>
      </div>
      <div id="promptArea"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Landing page logic
      const landing = document.getElementById('landing');
      const chatUI = document.getElementById('chatUI');
      const startBtn = document.getElementById('startBtn');

      let socket = null;
      let sessionId = null;
      let partnerType = null;
      const statusEl = document.getElementById('status');
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const promptArea = document.getElementById('promptArea');

      function addMessage(from, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (from === 'me' ? 'me' : 'partner');
        div.textContent = (from === 'me' ? 'Me: ' : 'Partner: ') + text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }


      function showChatUI() {
        landing.style.display = 'none';
        chatUI.style.display = '';
      }

      function saveSession() {
        localStorage.setItem('chatmirage_session', JSON.stringify({ sessionId, partnerType }));
      }

      function loadSession() {
        try {
          const data = JSON.parse(localStorage.getItem('chatmirage_session'));
          if (data && data.sessionId) {
            sessionId = data.sessionId;
            partnerType = data.partnerType;
            return true;
          }
        } catch {}
        return false;
      }

      function clearSession() {
        localStorage.removeItem('chatmirage_session');
      }

      function connectSocket() {
        const urlParams = new URLSearchParams(location.search);
        const forced = urlParams.get('force');
        socket = forced ? io({ auth: { forcePartner: forced } }) : io();

        socket.on('connect', () => {
          if (!sessionId) {
            statusEl.textContent = 'Connected. Searching for partner...';
          } else {
            statusEl.textContent = `Reconnected to session ${sessionId}`;
          }
        });

        socket.on('paired', (data) => {
          sessionId = data.sessionId;
          partnerType = data.partnerType;
          saveSession();
          statusEl.textContent = `Paired — Partner: ${data.partnerType} (${data.partnerId}) — Session ${sessionId}`;
          appendPromptArea('Paired! Say hi.');
        });

        socket.on('chat_message', (data) => {
          addMessage(data.from, data.text);
        });

        socket.on('turing_prompt', (data) => {
          promptArea.innerHTML = '';
          const p = document.createElement('div');
          p.textContent = data.prompt;
          promptArea.appendChild(p);
          const humanBtn = document.createElement('button');
          humanBtn.textContent = 'Human';
          humanBtn.onclick = () => submitGuess('Human');
          promptArea.appendChild(humanBtn);
          const aiBtn = document.createElement('button');
          aiBtn.textContent = 'AI';
          aiBtn.onclick = () => submitGuess('AI');
          promptArea.appendChild(aiBtn);
        });

        socket.on('guess_result', (data) => {
          if (data.correct) {
            appendPromptArea('Your guess was correct. Waiting for continue/end options...');
          } else {
            appendPromptArea('Incorrect guess.');
          }
        });

        socket.on('post_guess_options', (data) => {
          promptArea.innerHTML = '';
          const p = document.createElement('div');
          p.textContent = data.message;
          promptArea.appendChild(p);
          const cont = document.createElement('button');
          cont.textContent = 'Continue';
          cont.onclick = () => submitContinueChoice('continue');
          promptArea.appendChild(cont);
          const end = document.createElement('button');
          end.textContent = 'End Chat';
          end.onclick = () => submitContinueChoice('end');
          promptArea.appendChild(end);
        });

        socket.on('resume_chat', (data) => {
          appendPromptArea(data.message);
          setTimeout(() => (promptArea.innerHTML = ''), 1500);
        });

        socket.on('chat_ended', (data) => {
          appendPromptArea('Chat ended: ' + (data.reason || 'unknown'));
          statusEl.textContent = 'Chat ended. Reload page to try again.';
          inputEl.disabled = true;
          sendBtn.disabled = true;
          clearSession();
        });

        socket.on('partner_disconnected', (data) => {
          appendPromptArea(data.message || 'Partner disconnected');
          statusEl.textContent = 'Partner disconnected. Chat ended.';
          inputEl.disabled = true;
          sendBtn.disabled = true;
          clearSession();
        });

        function submitGuess(guess) {
          if (!sessionId) return;
          socket.emit('submit_guess', { sessionId, guess });
          appendPromptArea('You guessed: ' + guess);
        }

        function submitContinueChoice(choice) {
          if (!sessionId) return;
          socket.emit('submit_continue_choice', { sessionId, choice });
          appendPromptArea('You chose: ' + choice);
        }

        function appendPromptArea(text) {
          const d = document.createElement('div');
          d.textContent = text;
          promptArea.appendChild(d);
        }

        sendBtn.onclick = () => {
          const text = inputEl.value.trim();
          if (!text || !sessionId) return;
          socket.emit('send_message', { sessionId, text });
          inputEl.value = '';
        };

        inputEl.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            sendBtn.click();
          }
        });
      }

      // On page load, check for session and restore if possible
      if (loadSession()) {
        showChatUI();
        connectSocket();
      } else {
        startBtn.onclick = () => {
          showChatUI();
          connectSocket();
        };
      }
    </script>
  </body>
</html>
